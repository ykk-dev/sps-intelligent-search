sequenceDiagram
  autonumber
  participant User as User/App
  participant APIGW as API Gateway
  participant LQuery as Lambda (RAG Orchestrator)
  participant BR as Bedrock Runtime (Titan Embeddings)
  participant OS as OpenSearch (Vector Collection)
  participant LLM as Bedrock LLM (Generation)
  participant Obs as Logs/Tracing (CloudWatch/X-Ray)

  User->>APIGW: POST /ask {question}
  APIGW->>LQuery: Invoke request

  LQuery->>Obs: Log request and start trace

  LQuery->>BR: Embed query text (Titan)
  BR-->>LQuery: query embedding (float)
  LQuery->>LQuery: Quantize float -> int8 (byte vector)

  LQuery->>OS: kNN query (topK byte vectors)
  OS-->>LQuery: TopK chunks + metadata + scores

  LQuery->>LQuery: Build prompt with retrieved chunks
  LQuery->>LLM: Invoke LLM (grounded answer)
  LLM-->>LQuery: Answer + token usage

  LQuery->>Obs: Log metrics (latency, topK, tokens, model)
  LQuery-->>APIGW: Return {answer}
  APIGW-->>User: 200 OK
