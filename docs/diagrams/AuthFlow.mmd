sequenceDiagram
  autonumber
  participant Client as Client App
  participant Okta as Okta IdP
  participant APIGW as API Gateway
  participant RAG as Lambda RAG Orchestrator
  participant BR_E as Bedrock Runtime Embeddings
  participant OS as OpenSearch Domain
  participant BR_L as Bedrock LLM
  participant Obs as Logs and Tracing
  participant Audit as Audit Store

  Client->>Okta: User login and authentication
  Okta-->>Client: Issue access token JWT

  Client->>APIGW: POST ask with Authorization Bearer JWT
  APIGW->>APIGW: Validate JWT and enforce RBAC
  APIGW->>RAG: Invoke orchestrator with verified claims context

  RAG->>Obs: Start trace and log request
  RAG->>Audit: Write query audit record with user and role context

  RAG->>BR_E: Invoke embeddings using Lambda IAM role
  BR_E-->>RAG: Return query embedding vector
  RAG->>RAG: Quantize embedding if required

  RAG->>OS: kNN search using SigV4 IAM role authentication
  OS-->>RAG: Return top K chunks and metadata

  RAG->>RAG: Build prompt from retrieved context
  RAG->>BR_L: Invoke LLM using Lambda IAM role
  BR_L-->>RAG: Return grounded answer

  RAG->>Obs: Log latency tokens and status
  RAG->>Audit: Write completion audit record
  RAG-->>APIGW: Return response
  APIGW-->>Client: 200 OK with answer
