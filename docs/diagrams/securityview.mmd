flowchart LR

  %% ======== Identities / Principals ========
  subgraph Identities[Identities and Principals]
    User[End User / Client App]
    APIGW[API Gateway]
    LQ[Lambda Role: rag-query-role]
    LI[Lambda Role: rag-ingest-role]
    OSNode[OpenSearch Domain nodes]
    S3Svc[S3 Service]
  end

  %% ======== Region A (Active) ========
  subgraph RA[Region A - ACTIVE]
    subgraph NetA[Network Boundary: VPC + Private Subnets]
      LQFn["Lambda Query Function\n(in private subnets)"]
      LIFn["Lambda Ingestion Function\n(in private subnets)"]
    end

    S3A[S3 Docs Bucket]
    OSA["OpenSearch Domain\n(leader index)"]
    BRRT["Bedrock Runtime\n(InvokeModel for embeddings)"]
    BRLLM["Bedrock LLM\n(InvokeModel for generation)"]
    KMSA["KMS Key(s)\n(S3 + logs + secrets)"]
    CW[CloudWatch Logs / X-Ray]
    AUD["Audit Store\n(DynamoDB/S3/Logs)"]
  end

  %% ======== Region B (Hot Standby) ========
  subgraph RB[Region B - HOT STANDBY]
    S3B[S3 Replica Bucket]
    OSB["OpenSearch Domain\n(follower index)"]
    KMSB["KMS Key(s)"]
  end

  %% ======== AuthN/AuthZ at the Edge ========
  User -->|HTTPS| APIGW
  APIGW -->|AuthZ: JWT/Cognito/Lambda authorizer or IAM| LQFn

  %% ======== Trust Relationships ========
  APIGW -.invokes.-> LQFn
  S3Svc -.triggers.-> LIFn

  %% ======== Lambda assumes roles ========
  LQ -->|AssumeRole| LQFn
  LI -->|AssumeRole| LIFn

  %% ======== Query Path Permissions ========
  LQFn -->|IAM: bedrock:InvokeModel| BRRT
  LQFn -->|IAM: bedrock:InvokeModel| BRLLM
  LQFn -->|"SigV4 IAM to domain\n(es:ESHttpGet/ESHttpPost)"| OSA
  LQFn -->|Write logs/traces| CW
  LQFn -->|Write audit events| AUD

  %% ======== Ingestion Path Permissions ========
  LIFn -->|IAM: s3:GetObject| S3A
  LIFn -->|IAM: bedrock:InvokeModel| BRRT
  LIFn -->|"SigV4 IAM to domain\n(es:ESHttpPost/ESHttpPut)"| OSA
  LIFn -->|Write logs/traces| CW
  LIFn -->|Write audit records| AUD

  %% ======== Data-at-rest encryption ========
  S3A ---|SSE-KMS| KMSA
  CW ---|"KMS (optional)"| KMSA
  AUD ---|"KMS (optional)"| KMSA

  %% ======== Cross-region replication controls ========
  S3A ==>|S3 CRR bucket policy + IAM role| S3B
  OSA ==>|OpenSearch Replication| OSB

  %% ======== OpenSearch domain access policy boundary ========
  LQFn -.Allowed principal in\nDomain Access Policy.-> OSA
  LIFn -.Allowed principal in\nDomain Access Policy.-> OSA

  %% ======== Optional hardening notes ========
  APIGW -.Optional.-> WAF[WAF / rate limiting]
