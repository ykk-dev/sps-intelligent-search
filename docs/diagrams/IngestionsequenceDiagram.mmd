sequenceDiagram
  autonumber
  participant Author as Ops/ CSM/ SPA
  participant S3 as S3 (Docs Bucket)
  participant EVT as EventBridge/S3 Event
  participant LIngest as Lambda (Ingestion Orchestrator)
  participant Chunk as Chunker/Parser (in Lambda)
  participant BR as Bedrock Runtime (Titan Embeddings)
  participant OS as OpenSearch (Vector Collection)
  participant Meta as Metadata Store (optional)

  Author->>S3: Upload document (pdf/docx/etc)
  S3->>EVT: Emit ObjectCreated event
  EVT->>LIngest: Invoke ingestion workflow (doc key, bucket)

  LIngest->>S3: Get object (doc)
  LIngest->>Chunk: Extract text + split into chunks
  Chunk-->>LIngest: chunks[] with offsets/section/page info

  loop For each chunk
    LIngest->>BR: Invoke Titan embed (chunk text)
    BR-->>LIngest: embedding (float vector)
    LIngest->>LIngest: Quantize float -> int8 (byte vector)
    LIngest->>OS: Index chunk {vec(byte), text, metadata}
    OS-->>LIngest: 201 Created / indexed
  end

  rect rgba(240, 240, 240, 0.7)
    Note over LIngest,Audit: Audit purpose: store ingestion status, counts, timestamps, errors, trace ids
    LIngest->>Audit: Write audit record (doc_id, version, chunk_count, start/end, status)
    Audit-->>LIngest: OK
  end

  LIngest-->>EVT: Success (or failure)
